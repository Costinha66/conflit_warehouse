entity: refugee_displacement_conformed
grain: year

# --- Input schema & harmonization ---
input:
  columns:
    country_origin:         {sources: [country_origin], type: string, required: true, normalize: upper}
    year:                   {sources: [Year, year], type: int, required: true}
  lineage: [_source_id, _bronze_file, _ingest_run_id, _transform_version]

# --- Dimension joins (pure lookups, left join) ---
dims:
  - name: countries
    path: warehouse/dims/countries_dim.parquet
    on:   {left: country_origin, right: iso_country}
    select: [region_unhcr, region_unsd, subregion_unsd]
    alias: origin_
    required: true               # if false â†’ rows with no match go to rejects: iso3_unknown
  - name: countries
    path: warehouse/dims/countries_dim.parquet
    on:   {left: country_destination, right: iso_country}
    select: [region_unhcr, region_unsd, subregion_unsd]
    alias: dest_
    required: true

# --- Row-level rules (DQ / filters) ---
rules:
  - name: valid_year_bounds
    when: "year >= 1990 and year <= 2035"
    action: keep                # or reject: reason: year_out_of_bounds
    reject_reason: year_out_of_bounds
# --- Row hash over canonical business columns (not lineage) ---
row_hash:
  columns: [country_origin, country_destination, year]

# --- Output contract ---
output:
  columns: [country_origin,origin_region_unhcr, origin_region_unsd, origin_subregion_unsd
            ,country_destination,dest_region_unhcr, dest_region_unsd, dest_subregion_unsd,
            ,refugees,asylum_seekers,idps,stateless,hst,ooc,year]
  lineage: [_bronze_file, _ingest_run_id, _transform_version]
