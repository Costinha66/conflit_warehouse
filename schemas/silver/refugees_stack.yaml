# refugee_displacement_conformed.yaml
entity: refugee_displacement_conformed
version: 1
grain: year

contract:
  primary_key: [country_origin, country_destination, year]
  partitions:  [year]
  lineage: [_build_at, _ingest_run_id, _transform_version]
  columns:
    - name: origin_country_id
      type: BIGINT
      nullable: false
    - name: dest_country_id
      type: BIGINT
      nullable: false
    - name: country_origin
      type: STRING
      nullable: false
      source: [country_of_origin]
    - name: country_destination
      type: STRING
      nullable: false
      source: [country_of_asylum]
    - name: refugees
      type: BIGINT
      nullable: false
      dq: ">= 0"
      source: [refugees]
    - name: asylum_seekers
      type: BIGINT
      nullable: false
      dq: ">= 0"
      source: [asylum_seekers]
    - name: idps
      type: BIGINT
      nullable: false
      dq: ">= 0"
      source: [idps]
    - name: stateless
      type: BIGINT
      nullable: false
      dq: ">= 0"
      source: [stateless]
    - name: host_community
      type: BIGINT
      nullable: false
      dq: ">= 0"
      source: [hst]
    - name: others_of_concern
      type: BIGINT
      nullable: false
      dq: ">= 0"
      source: [ooc]
    - name: year
      type: INT
      nullable: false
      source: [year]

canonicalizer:
  input:
    normalize:
      country_origin: [strip, upper]
      country_destination: [strip, upper]
  dims:
    - name: countries
      path: warehouse/dims/countries_dim.parquet
      on_keys:   {left: country_origin, right: iso_country}
      select: [region_unhcr, sub_region_unhcr, country_id]
      alias: origin_
      required: true
    - name: countries
      path: warehouse/dims/countries_dim.parquet
      on_keys:   {left: country_destination, right: iso_country}
      select: [region_unhcr, sub_region_unhcr, country_id]
      alias: dest_
      required: true
  rules:
    - name: valid_year_bounds
      when: "year >= 1990 and year <= 2035"
      action: keep
      reject_reason: year_out_of_bounds

  dedup:
    key:   [country_origin, country_destination, year]
    tiebreak:
      - column: _ingest_run_id
        order: desc

  row_hash:
    columns: [country_origin, country_destination, year, refugees, asylum_seekers, idps, stateless, host_community, others_of_concern]

  output:
    lineage: [_build_at, _ingest_run_id, _transform_version]
    extra: [origin_region_unhcr, origin_sub_region_unhcr,
            dest_region_unhcr,   dest_sub_region_unhcr]
